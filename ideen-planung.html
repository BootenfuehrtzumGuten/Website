<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ideen & Planung | M.I.E Modern IT Experts GmbH</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary:#005BBB;
      --color-accent:#00B8D9;
      --color-dark:#0A1F44;
      --color-bg:#F7F9FC;
      --color-text:#333;
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Inter',sans-serif;
      margin:0;
      background:var(--color-bg);
      color:var(--color-text);
    }
    .container{
      max-width:1100px;
      margin:40px auto 60px;
      padding:0 20px;
    }
    h1{
      font-size:2rem;
      margin-bottom:10px;
      color:var(--color-dark);
    }
    p.lead{
      margin-top:0;
      color:#555;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:20px 0;
    }
    .btn{
      padding:10px 16px;
      border:none;
      border-radius:8px;
      background:var(--color-primary);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:0.95rem;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    }
    .btn.secondary{
      background:#fff;
      color:var(--color-dark);
      border:1px solid #ccd6e0;
    }
    .btn:hover{
      background:#0070e0;
    }
    .btn.secondary:hover{
      background:#f1f5fb;
    }
    #project-list{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:20px;
      margin-top:20px;
    }
    .project-card{
      background:#fff;
      border-radius:16px;
      padding:18px 16px 14px;
      box-shadow:0 8px 20px rgba(10,31,68,0.06);
      display:flex;
      flex-direction:column;
      min-height:220px;
      position:relative;
    }
    .project-card h3{
      margin:0 0 4px;
      font-size:1.1rem;
      color:var(--color-dark);
    }
    .project-meta{
      font-size:0.8rem;
      color:#7b8898;
      margin-bottom:8px;
    }
    .tags{
      margin:6px 0 10px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      background:var(--color-primary);
      color:#fff;
      padding:3px 8px;
      border-radius:999px;
      font-size:0.75rem;
      cursor:pointer;
      border:none;
    }
    .tag small{
      font-size:0.7rem;
      opacity:.8;
    }
    .project-card textarea{
      width:100%;
      min-height:60px;
      resize:vertical;
      border-radius:10px;
      border:1px solid #dde3ec;
      padding:6px 8px;
      font-family:inherit;
      font-size:0.85rem;
      margin-top:6px;
      margin-bottom:4px;
    }
    .task-input,
    .tag-input,
    .github-input{
      width:100%;
      padding:7px 9px;
      margin-top:6px;
      border-radius:10px;
      border:1px solid #dde3ec;
      font-size:0.85rem;
    }
    .project-footer{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
      justify-content:space-between;
      align-items:center;
    }
    .small-btn{
      padding:6px 10px;
      border-radius:999px;
      font-size:0.75rem;
      border:none;
      background:#eef2fb;
      color:var(--color-dark);
      cursor:pointer;
    }
    .small-btn.danger{
      background:#ffe5e5;
      color:#b30000;
    }
    .small-btn:hover{
      background:#dde4f7;
    }
    .small-btn.danger:hover{
      background:#ffd0d0;
    }
    .status-pill{
      padding:4px 10px;
      border-radius:999px;
      font-size:0.75rem;
      background:#eef2fb;
      color:var(--color-dark);
      cursor:pointer;
    }
    .status-pill[data-status="todo"]{background:#fff4d6;color:#8a5b00;}
    .status-pill[data-status="doing"]{background:#e3f2ff;color:#005BBB;}
    .status-pill[data-status="done"]{background:#e6f7e9;color:#1a7f37;}
    @media(max-width:768px){
      .container{margin-top:20px;}
    }
  </style>
</head>
<body>

<header id="site-nav"></header>
<script>
fetch('nav.html').then(r=>r.text()).then(html=>document.getElementById('site-nav').innerHTML=html);
</script>

<main class="container">
  <h1>Ideen & Planung</h1>
  <p class="lead">Hier kannst du zukünftige Projekte, Features und Experimente sammeln, strukturieren und mit Tags & Aufgaben versehen.</p>

  <div class="controls">
    <button class="btn" id="add-project">＋ Neues Projekt</button>
    <button class="btn secondary" id="export-json">⬇ Backup als JSON</button>
    <label class="btn secondary" style="display:inline-flex;align-items:center;gap:6px;">
      ⬆ Backup importieren
      <input type="file" id="import-json" style="display:none">
    </label>
  </div>

  <div id="project-list"></div>
</main>

<footer id="site-footer"></footer>
<script>
fetch('footer.html').then(r=>r.text()).then(html=>document.getElementById('site-footer').innerHTML=html);
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').then(() => console.log('Service Worker registriert'));
}

async function loadProjects() {
  const response = await fetch('load.php');
  try {
    return await response.json();
  } catch(e) {
    console.error('Fehler beim JSON-Parsing von load.php', e);
    return [];
  }
}

async function saveProjects(data) {
  await fetch('save.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
}

let projects = [];

function renderProjects() {
  const container = document.getElementById('project-list');
  container.innerHTML = '';

  projects.forEach((project, index) => {
    const card = document.createElement('div');
    card.className = 'project-card';

    const status = project.status || 'todo';
    const tagsHTML = (project.tags || []).map((tag, tIndex) => `
      <button class="tag" onclick="removeTag(${index}, ${tIndex})">
        ${tag} <small>✖</small>
      </button>
    `).join('');

    const tasksHTML = (project.tasks || []).map(task => `<li>${task}</li>`).join('');

    card.innerHTML = `
      <h3>${index + 1}. ${project.name}</h3>
      <div class="project-meta">
        <span class="status-pill" data-status="${status}" onclick="cycleStatus(${index})">
          ${status === 'todo' ? 'Idee' : status === 'doing' ? 'In Arbeit' : 'Abgeschlossen'}
        </span>
      </div>
      <div class="tags">${tagsHTML}</div>
      <input type="text" class="tag-input" placeholder="Neuen Tag hinzufügen" id="tag-input-${index}">

      <ul style="margin:8px 0 4px 18px;font-size:0.85rem;">
        ${tasksHTML}
      </ul>
      <input type="text" class="task-input" placeholder="Neuer Arbeitspunkt" id="task-input-${index}">

      <input type="text" class="github-input" placeholder="GitHub / Link" value="${project.github || ''}" id="github-input-${index}">

      <div class="project-footer">
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="small-btn" onclick="addTag(${index})">Tag＋</button>
          <button class="small-btn" onclick="addTask(${index})">Task＋</button>
          <button class="small-btn" onclick="updateGithub(${index})">Link speichern</button>
        </div>
        <button class="small-btn danger" onclick="deleteProject(${index})">Löschen</button>
      </div>
    `;

    container.appendChild(card);
  });
}

function addTask(index) {
  const input = document.getElementById(`task-input-${index}`);
  const task = input.value.trim();
  if (task) {
    projects[index].tasks = projects[index].tasks || [];
    projects[index].tasks.push(task);
    input.value = '';
    saveProjects(projects);
    renderProjects();
  }
}

function addTag(index) {
  const input = document.getElementById(`tag-input-${index}`);
  const tag = input.value.trim();
  if (tag) {
    projects[index].tags = projects[index].tags || [];
    projects[index].tags.push(tag);
    input.value = '';
    saveProjects(projects);
    renderProjects();
  }
}

function removeTag(projectIndex, tagIndex) {
  projects[projectIndex].tags.splice(tagIndex, 1);
  saveProjects(projects);
  renderProjects();
}

function updateGithub(index) {
  const input = document.getElementById(`github-input-${index}`);
  projects[index].github = input.value.trim();
  saveProjects(projects);
}

function cycleStatus(index) {
  const current = projects[index].status || 'todo';
  const next = current === 'todo' ? 'doing' : current === 'doing' ? 'done' : 'todo';
  projects[index].status = next;
  saveProjects(projects);
  renderProjects();
}

function deleteProject(index){
  if(!confirm('Dieses Projekt wirklich löschen?')) return;
  projects.splice(index,1);
  saveProjects(projects);
  renderProjects();
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('add-project').addEventListener('click', () => {
    const name = prompt('Projektname eingeben:');
    if (name) {
      projects.push({ name: name, tasks: [], tags: [], github: '', status: 'todo' });
      saveProjects(projects);
      renderProjects();
    }
  });

  document.getElementById('export-json').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(projects, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'plaene_backup.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('import-json').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        projects = JSON.parse(reader.result || '[]');
        saveProjects(projects);
        renderProjects();
      };
      reader.readAsText(file);
    }
  });

  (async () => {
    projects = await loadProjects();
    if (!Array.isArray(projects)) projects = [];
    renderProjects();
  })();
});
</script>

</body>
</html>
