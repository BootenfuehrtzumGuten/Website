<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Schulungsplanung â€“ Kalender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f5fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1450px;
      margin: 20px auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    /* PDF Export Bar */
    .export-bar {
      text-align:right;
      margin-bottom:15px;
    }

    .export-bar select {
      padding:6px 10px;
      font-size:0.95rem;
      border-radius:6px;
    }

    .btn-primary {
      background:#0066ff;
      color:white;
      padding:7px 14px;
      border-radius:6px;
      border:none;
      cursor:pointer;
    }

    .layout {
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:20px;
    }

    #calendar {
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      min-height:900px;
    }

    .fc-daygrid-day-frame {
      min-height:130px !important;
    }

    /* Mehrzeiliger Event-Text */
    .fc-event-main {
      white-space:normal !important;
      padding:4px;
      overflow-wrap:break-word;
      word-break:break-word;
      max-height:85px;
      overflow:hidden;
      font-size:0.78rem;
      line-height:1.25;
    }

    .details-box {
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      min-height:900px;
    }

    .entry {
      border-bottom:1px solid #ddd;
      padding:10px 0;
    }

    .entry-title {font-weight:bold;}
    .entry-meta {font-size:0.8rem; color:#555;}
    .entry-text {margin-top:5px;}

    /* MODAL */
    #editModal {
      position:fixed;
      inset:0;
      display:none;
      background:rgba(0,0,0,0.55);
      justify-content:center;
      align-items:center;
      z-index:9999;
    }

    .modal-content {
      background:white;
      padding:20px;
      border-radius:12px;
      width:470px;
    }

    label {
      font-weight:bold;
      font-size:0.9rem;
    }

    input, textarea {
      width:100%;
      padding:8px;
      margin:5px 0 12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:0.95rem;
    }

    .btn-danger {
      background:#cc0000;
      color:white;
      padding:7px 14px;
      border-radius:6px;
      border:none;
      cursor:pointer;
    }

    .btn-ghost {
      padding:7px 14px;
      background:#eee;
      border-radius:6px;
      cursor:pointer;
    }

  </style>
</head>

<body>

<div class="container">

  <h1>ðŸ“… Schulungsplanung</h1>

  <!-- PDF EXPORT + TRÃ„GERAUSWAHL -->
  <div class="export-bar">
      <select id="traegerSelect">
        <option value="">-- TrÃ¤ger auswÃ¤hlen --</option>
      </select>
      <button onclick="exportTraegerPdf()" class="btn-primary">ðŸ“„ PDF exportieren</button>
  </div>

  <div class="layout">

    <div id="calendar"></div>

    <div class="details-box">
      <h2 id="detailDate">WÃ¤hle einen Tag</h2>
      <div id="dayDetails">Noch kein Tag ausgewÃ¤hlt.</div>
    </div>

  </div>
</div>



<!-- MODAL -->
<div id="editModal">
  <div class="modal-content">

    <h2 id="modalTitle">Termin</h2>

    <form id="editForm">

      <input type="hidden" id="edit_id">
      <input type="hidden" id="edit_datum">

      <label>TrÃ¤ger</label>
      <input id="edit_traeger">

      <label>Lehrgang</label>
      <input id="edit_lehrgang">

      <label>Thema</label>
      <input id="edit_thema">

      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
          <label>Von</label>
          <input type="time" id="edit_von">
        </div>
        <div style="flex:1;">
          <label>Bis</label>
          <input type="time" id="edit_bis">
        </div>
      </div>

      <label>Beschreibung</label>
      <textarea id="edit_beschreibung" rows="4"></textarea>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">

        <button type="button" id="duplicateButton" class="btn-primary">ðŸ“„ Duplizieren</button>
        <button type="button" id="deleteButton" class="btn-danger" style="display:none;">ðŸ—‘ LÃ¶schen</button>

        <div>
          <button type="button" class="btn-ghost" onclick="closeEditModal()">Abbrechen</button>
          <button type="submit" class="btn-primary">Speichern</button>
        </div>

      </div>

    </form>

  </div>
</div>




<script>
let calendar;
let allEvents = [];
let selectedDate = null;

/* --- Farben pro Lehrgang --- */
const colorMap = {};
const colorPalette = [
  "#4CAF50","#2196F3","#FF9800","#9C27B0",
  "#E91E63","#795548","#3F51B5","#00BCD4",
  "#673AB7","#009688","#FF5722","#607D8B"
];

function getColorForCourse(course) {
  if (!colorMap[course]) {
    colorMap[course] =
      colorPalette[Object.keys(colorMap).length % colorPalette.length];
  }
  return colorMap[course];
}

function formatEU(d){
  const p = d.split("-");
  return p[2] + "." + p[1] + "." + p[0];
}


/* --- TrÃ¤gerliste laden --- */
function loadTraegerList() {
  fetch("schulungen_load.php")
    .then(r => r.json())
    .then(data => {
      const sel = document.getElementById("traegerSelect");
      let set = new Set();

      data.forEach(ev => {
        if (ev.traeger && ev.traeger.trim() !== "") {
          set.add(ev.traeger.trim());
        }
      });

      sel.innerHTML = '<option value="">-- TrÃ¤ger auswÃ¤hlen --</option>';

      [...set].sort().forEach(t => {
        sel.innerHTML += `<option value="${t}">${t}</option>`;
      });
    });
}


/* --- PDF Export --- */
function exportTraegerPdf() {
  const t = document.getElementById("traegerSelect").value;
  if (!t) {
    alert("Bitte erst einen TrÃ¤ger auswÃ¤hlen.");
    return;
  }
  window.open(
    "schulungen_export_pdf.php?traeger=" + encodeURIComponent(t),
    "_blank"
  );
}


/* --- Modal Ã¶ffnen --- */
function openEditModal(data){
  document.getElementById("edit_id").value = data.id || "";
  document.getElementById("edit_datum").value = data.datum || "";
  document.getElementById("edit_traeger").value = data.traeger || "";
  document.getElementById("edit_lehrgang").value = data.lehrgang || "";
  document.getElementById("edit_thema").value = data.thema || "";
  document.getElementById("edit_von").value = data.von || "";
  document.getElementById("edit_bis").value = data.bis || "";
  document.getElementById("edit_beschreibung").value = data.beschreibung || "";

  document.getElementById("modalTitle").textContent =
    (data.id ? "Termin bearbeiten â€“ " : "Neuer Termin â€“ ") + formatEU(data.datum);

  const delBtn = document.getElementById("deleteButton");
  const dupBtn = document.getElementById("duplicateButton");

  if (data.id) {
    delBtn.style.display = "inline-block";
    delBtn.onclick = () => deleteEntry(data.id);

    dupBtn.style.display = "inline-block";
    dupBtn.onclick = () => duplicateEntry(data);

  } else {
    delBtn.style.display = "none";
    dupBtn.style.display = "none";
  }

  document.getElementById("editModal").style.display = "flex";
}

function closeEditModal(){
  document.getElementById("editModal").style.display = "none";
}

function duplicateEntry(ev){
  const payload = {
    id: "",
    datum: ev.datum,
    traeger: ev.traeger,
    lehrgang: ev.lehrgang,
    thema: ev.thema,
    von: ev.von,
    bis: ev.bis,
    beschreibung: ev.beschreibung
  };
  saveEntry(payload,true);
}


/* --- Speichern & LÃ¶schen --- */
function saveEntry(payload, close=true){
  fetch("schulungen_save.php",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(()=>{
    if (close) closeEditModal();
    calendar.refetchEvents();
    loadDayDetails(payload.datum);
    loadTraegerList();
  });
}

function deleteEntry(id){
  if (!confirm("Termin wirklich lÃ¶schen?")) return;

  fetch("schulungen_save.php",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({delete:true,id})
  })
  .then(r=>r.json())
  .then(()=>{
    closeEditModal();
    calendar.refetchEvents();
    loadDayDetails(selectedDate);
    loadTraegerList();
  });
}


/* --- Tagesdetails --- */
function loadDayDetails(date){
  selectedDate = date;
  document.getElementById("detailDate").textContent = "Termine am " + formatEU(date);

  const box = document.getElementById("dayDetails");
  const list = allEvents.filter(ev => ev.datum === date);

  if (!list.length){
    box.innerHTML = "<p>Keine Termine.</p>";
    return;
  }

  let html = "";
  list.forEach(ev => {
    html += `
      <div class="entry">
        <div class="entry-title">${ev.lehrgang}</div>
        <div class="entry-meta">${ev.von} â€“ ${ev.bis}</div>
        <div class="entry-text">${(ev.beschreibung||"").replace(/\n/g,"<br>")}</div>
        <button class="btn-danger" onclick="deleteEntry('${ev.id}')">LÃ¶schen</button>
      </div>
    `;
  });

  box.innerHTML = html;
}



/* --- Kalender Initialisieren --- */
document.addEventListener("DOMContentLoaded", function () {

  loadTraegerList();

  calendar = new FullCalendar.Calendar(document.getElementById("calendar"),{
    initialView:"dayGridMonth",
    locale:"de",
    firstDay:1,
    selectable:true,
    editable:true,

    eventContent(info){
      let ev = info.event.extendedProps;

      return {
        html: `
          <div><strong>${ev.lehrgang}</strong></div>
          <div style="font-size:0.75rem; opacity:0.9;">${ev.thema || ""}</div>
        `
      };
    },

    events: function(fetchInfo, success){
      fetch("schulungen_load.php")
        .then(r=>r.json())
        .then(data=>{
          allEvents = data;
          success(data.map(ev => ({
            id: ev.id,
            title: ev.lehrgang,
            start: ev.von ? ev.datum+"T"+ev.von : ev.datum,
            backgroundColor: getColorForCourse(ev.lehrgang),
            borderColor: getColorForCourse(ev.lehrgang),
            textColor: "white",
            extendedProps: ev
          })));
        });
    },

    dateClick(info){
      selectedDate = info.dateStr;
      loadDayDetails(selectedDate);
      openEditModal({datum:selectedDate});
    },

    eventClick(info){
      selectedDate = info.event.extendedProps.datum;
      loadDayDetails(selectedDate);
      openEditModal(info.event.extendedProps);
    },

    eventDrop(info){
      let ev = info.event.extendedProps;

      saveEntry({
        id: ev.id,
        datum: info.event.startStr.split("T")[0],
        traeger: ev.traeger,
        lehrgang: ev.lehrgang,
        thema: ev.thema,
        von: ev.von,
        bis: ev.bis,
        beschreibung: ev.beschreibung
      }, false);
    }
  });

  calendar.render();

  document.getElementById("editForm").addEventListener("submit", function(e){
    e.preventDefault();

    let payload = {
      id: document.getElementById("edit_id").value,
      datum: document.getElementById("edit_datum").value,
      traeger: document.getElementById("edit_traeger").value,
      lehrgang: document.getElementById("edit_lehrgang").value,
      thema: document.getElementById("edit_thema").value,
      von: document.getElementById("edit_von").value,
      bis: document.getElementById("edit_bis").value,
      beschreibung: document.getElementById("edit_beschreibung").value
    };

    saveEntry(payload);
  });
});
</script>

</body>
</html>
