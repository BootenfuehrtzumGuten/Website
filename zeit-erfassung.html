<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung | M.I.E Modern IT Experts GmbH</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root { --color-primary:#005BBB; --color-dark:#0A1F44; --color-bg:#F7F9FC; }
body { font-family:Inter, sans-serif; background:var(--color-bg); margin:0; color:#333; }
.container { max-width:1000px; margin:40px auto; padding:0 20px; }
h1 {color:var(--color-dark);}
input, select, textarea {
  width:100%; padding:10px; margin:8px 0;
  border:1px solid #ccc; border-radius:8px; font-size:1rem;
}
button {
  padding:10px 16px; border:none; border-radius:8px;
  background:var(--color-primary); color:#fff; cursor:pointer; font-weight:600;
}
button:hover { background:#0080ff; }
.tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab {
  padding:10px 18px; border-radius:8px; border:1px solid #ccc; background:#fff;
  cursor:pointer; font-weight:600;
}
.tab.active { background:#005BBB; color:#fff; border-color:#005BBB; }
.tab-content { display:none; background:#fff; padding:20px; border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08); }
.tab-content.active { display:block; }
.entry { background:#fff; padding:14px; margin-top:12px; border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08); }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { padding:6px 4px; font-size:0.9rem; }
th { border-bottom:1px solid #ccc; text-align:left; }
td.num { text-align:right; }
.flex-row { display:flex; gap:16px; flex-wrap:wrap; }
.flex-row > div { flex:1 1 240px; }
small.hint { color:#777; font-size:0.8rem; }
</style>
</head>

<body>

<header id="site-nav"></header>
<script>
fetch('nav.html').then(r=>r.text()).then(html=>document.getElementById('site-nav').innerHTML=html);
</script>

<div class="container">

<h1>â±ï¸ Zeiterfassung & Auswertung</h1>

<div class="tabs">
  <button class="tab active" onclick="openTab('eingabe', event)">ğŸ“ Eingabe</button>
  <button class="tab" onclick="openTab('tabelle', event)">ğŸ“‹ Tabelle</button>
  <button class="tab" onclick="openTab('auswertung', event)">ğŸ“Š Auswertung</button>
  <button class="tab" onclick="openTab('export', event)">ğŸ“¤ Export / Rechnungen</button>
</div>

<!-- TAB: Eingabe -->
<div id="eingabe" class="tab-content active">
  <h2>Zeiterfassung eingeben</h2>

  <label>Kunde:</label>
  <input id="kunde" list="kundenListe" placeholder="Kunde eingeben oder auswÃ¤hlen">
  <datalist id="kundenListe"></datalist>

  <label>Art der TÃ¤tigkeit:</label>
  <select id="art">
    <option>Administration</option>
    <option>Support</option>
    <option>Absprache</option>
    <option>Call</option>
  </select>

  <label>Datum:</label>
  <input type="date" id="datum">

  <label>Beschreibung:</label>
  <textarea id="desc" rows="3" placeholder="Kurzbeschreibung der TÃ¤tigkeit"></textarea>

  <h3>â±ï¸ Zeit erfassen</h3>
  <button id="timerBtn" onclick="toggleTimer()">â–¶ Timer starten</button>
  <small class="hint">Timer nutzt aktuelle Uhrzeit und speichert Dauer automatisch.</small>

  <p style="margin-top:10px;">ODER manuell eingeben:</p>
  <input type="number" id="manualTime" placeholder="Minuten z. B. 30">
  <button onclick="saveManual()">ğŸ–Šï¸ Manuell speichern</button>
</div>

<!-- TAB: Tabelle -->
<div id="tabelle" class="tab-content">
  <h2>ğŸ“‹ Ãœbersicht aller EintrÃ¤ge</h2>

  <div class="flex-row">
    <div>
      <label>Filter Kunde:</label>
      <select id="filter-kunde">
        <option value="">(alle)</option>
      </select>
    </div>
    <div>
      <label>Von (Datum):</label>
      <input type="date" id="filter-von">
    </div>
    <div>
      <label>Bis (Datum):</label>
      <input type="date" id="filter-bis">
    </div>
    <div style="align-self:flex-end;">
      <button onclick="renderEntries()">Filter anwenden</button>
    </div>
  </div>

  <div id="entries"></div>
</div>

<!-- TAB: Auswertung -->
<div id="auswertung" class="tab-content">
  <h2>ğŸ“Š Auswertung</h2>

  <div class="flex-row">
    <div>
      <label>Kunde (optional):</label>
      <select id="stats-kunde">
        <option value="">(alle)</option>
      </select>
    </div>
    <div>
      <label>Von:</label>
      <input type="date" id="stats-von">
    </div>
    <div>
      <label>Bis:</label>
      <input type="date" id="stats-bis">
    </div>
    <div style="align-self:flex-end;">
      <button onclick="renderStats()">Neu berechnen</button>
    </div>
  </div>

  <div id="stats"></div>
</div>

<!-- TAB: Export / Rechnungen -->
<div id="export" class="tab-content">
  <h2>ğŸ“¤ Export & Leistungsnachweise</h2>

  <h3>Statusbericht (PDF) â€“ 1 Tag / Kunde</h3>
  <div class="flex-row">
    <div>
      <label>Kunde:</label>
      <select id="pdf-kunde"></select>
    </div>
    <div>
      <label>Datum:</label>
      <input type="date" id="pdf-datum">
    </div>
    <div style="align-self:flex-end;">
      <button onclick="generateStatusPDF()">ğŸ“„ Statusbericht als PDF</button>
    </div>
  </div>

  <hr style="margin:20px 0;">

  <h3>Leistungsnachweis / Rechnung (PDF) â€“ Zeitraum / Kunde</h3>
  <div class="flex-row">
    <div>
      <label>Kunde:</label>
      <select id="inv-kunde"></select>
    </div>
    <div>
      <label>Von:</label>
      <input type="date" id="inv-von">
    </div>
    <div>
      <label>Bis:</label>
      <input type="date" id="inv-bis">
    </div>
    <div>
      <label>Stundensatz (EUR):</label>
      <input type="number" id="inv-rate" placeholder="z. B. 95" step="0.01">
    </div>
    <div style="align-self:flex-end;">
      <button onclick="generateInvoicePDF()">ğŸ“‘ Leistungsnachweis / Rechnung PDF</button>
    </div>
  </div>

  <hr style="margin:20px 0;">

  <h3>CSV Export (komplett, gefiltert im Browser)</h3>
  <button onclick="exportCSV()">ğŸ“¥ CSV Export</button>
</div>

</div>

<footer id="site-footer"></footer>
<script>
fetch('footer.html').then(r=>r.text()).then(html=>document.getElementById('site-footer').innerHTML=html);
</script>

<script>
let timerRunning=false, startTime=null, editIndex=null, entries=[];

function formatDateEU(dateStr){
  if(!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

function openTab(name, ev){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(ev) ev.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  if(name==='tabelle') renderEntries();
  if(name==='auswertung') renderStats();
}

function loadCustomers(){
  fetch('kunden.json')
    .then(r=>r.json())
    .then(list=>{
      const dl=document.getElementById('kundenListe');
      const filterK=document.getElementById('filter-kunde');
      const statsK=document.getElementById('stats-kunde');
      const pdfK=document.getElementById('pdf-kunde');
      const invK=document.getElementById('inv-kunde');
      dl.innerHTML='';
      [filterK, statsK, pdfK, invK].forEach(sel => sel.innerHTML = sel.id==='filter-kunde' || sel.id==='stats-kunde' ? '<option value="">(alle)</option>' : '');
      list.forEach(k=>{
        dl.innerHTML+=`<option value="${k}"></option>`;
        [filterK, statsK, pdfK, invK].forEach(sel=>{
          const opt=document.createElement('option');
          opt.value=k; opt.textContent=k;
          sel.appendChild(opt);
        });
      });
    });
}

function loadEntriesFromServer(){
  fetch('api_load_entries.php')
    .then(r=>r.json())
    .then(data=>{
      entries = Array.isArray(data)?data:[];
      renderEntries();
      renderStats();
    });
}

function saveEntriesToServer(){
  return fetch('api_save_entries.php',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(entries)
  })
  .then(r=>r.json())
  .then(data=>{ entries=data; });
}

function getTimeString24h(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

function toggleTimer(){
  if(!timerRunning){
    startTime=Date.now();
    timerRunning=true;
    document.getElementById('timerBtn').innerText="â¹ Timer stoppen";
  } else {
    const dur=((Date.now()-startTime)/60000).toFixed(1);
    saveEntry(dur);
    timerRunning=false;
    document.getElementById('timerBtn').innerText="â–¶ Timer starten";
  }
}

function saveManual(){
  const m=document.getElementById("manualTime").value;
  if(!m) return alert("Bitte Minuten eingeben!");
  saveEntry(m);
  document.getElementById("manualTime").value='';
}

function saveEntry(duration){
  const kunde=document.getElementById("kunde").value.trim(),
        art=document.getElementById("art").value,
        desc=document.getElementById("desc").value.trim(),
        datum=document.getElementById("datum").value;

  if(!kunde) return alert("Bitte Kunde eingeben!");
  if(!datum) return alert("Bitte Datum wÃ¤hlen!");

  const entry={
    kunde, art, desc, duration: parseFloat(duration),
    datum, zeit:getTimeString24h()
  };

  if(editIndex!==null){
    entries[editIndex]=entry;
    editIndex=null;
  } else {
    entries.push(entry);
  }

  saveEntriesToServer().then(()=>{
    renderEntries();
    renderStats();
  });
}

function entryPassesFilter(e){
  const fk=document.getElementById('filter-kunde').value;
  const von=document.getElementById('filter-von').value;
  const bis=document.getElementById('filter-bis').value;
  if(fk && e.kunde!==fk) return false;
  if(von && e.datum < von) return false;
  if(bis && e.datum > bis) return false;
  return true;
}

function renderEntries(){
  const box=document.getElementById("entries");
  const filtered = entries.filter(entryPassesFilter);
  if(!filtered.length){ box.innerHTML="<p>Noch keine passenden EintrÃ¤ge.</p>"; return; }

  box.innerHTML=filtered.map((e,i)=>`
    <div class="entry">
      <b>${e.kunde}</b> â€“ ${e.art} â€“ ${e.duration} Min<br>
      <small>${formatDateEU(e.datum)} um ${e.zeit} Uhr</small>
      <p>${e.desc}</p>
      <button onclick="editEntry(${i})" style="background:#FFA500;">âœï¸ Bearbeiten</button>
      <button onclick="deleteEntry(${i})" style="background:#D9534F;">âŒ LÃ¶schen</button>
    </div>
  `).join('');
}

function deleteEntry(i){
  if(!confirm("Diesen Eintrag wirklich lÃ¶schen?")) return;
  entries.splice(i,1);
  saveEntriesToServer().then(()=>{
    renderEntries();
    renderStats();
  });
}

function editEntry(i){
  const e=entries[i];
  document.getElementById('kunde').value=e.kunde;
  document.getElementById('art').value=e.art;
  document.getElementById('datum').value=e.datum;
  document.getElementById('desc').value=e.desc;
  editIndex=i;
  openTab('eingabe');
}

function statsFilter(e){
  const sk=document.getElementById('stats-kunde').value;
  const von=document.getElementById('stats-von').value;
  const bis=document.getElementById('stats-bis').value;
  if(sk && e.kunde!==sk) return false;
  if(von && e.datum < von) return false;
  if(bis && e.datum > bis) return false;
  return true;
}

function getISOWeek(d){
  const date = new Date(d.getTime());
  date.setHours(0,0,0,0);
  date.setDate(date.getDate() + 3 - ((date.getDay()+6)%7));
  const week1 = new Date(date.getFullYear(),0,4);
  return 1 + Math.round(((date - week1)/86400000 - 3 + ((week1.getDay()+6)%7))/7);
}

function renderStats(){
  const sdiv=document.getElementById("stats");
  const filtered = entries.filter(statsFilter);
  if(!filtered.length){
    sdiv.innerHTML="<p>Keine EintrÃ¤ge im gewÃ¤hlten Zeitraum.</p>";
    return;
  }

  let total=0;
  const byCustomer={}, byWeek={}, byMonth={};

  filtered.forEach(e=>{
    const dur=parseFloat(e.duration)||0;
    total+=dur;

    // Kunden
    byCustomer[e.kunde]=(byCustomer[e.kunde]||0)+dur;

    // Woche
    const d=new Date(e.datum);
    if(!isNaN(d)){
      const year=d.getFullYear();
      const week=getISOWeek(d);
      const key=`KW ${week}/${year}`;
      byWeek[key]=(byWeek[key]||0)+dur;

      const monthKey=`${String(d.getMonth()+1).padStart(2,'0')}.${year}`;
      byMonth[monthKey]=(byMonth[monthKey]||0)+dur;
    }
  });

  const custRows = Object.keys(byCustomer).map(k=>`
    <tr><td>${k}</td><td class="num">${byCustomer[k].toFixed(1)}</td><td class="num">${(byCustomer[k]/60).toFixed(2)}</td></tr>
  `).join('');

  const weekRows = Object.keys(byWeek).sort().map(k=>`
    <tr><td>${k}</td><td class="num">${byWeek[k].toFixed(1)}</td><td class="num">${(byWeek[k]/60).toFixed(2)}</td></tr>
  `).join('');

  const monthRows = Object.keys(byMonth).sort().map(k=>`
    <tr><td>${k}</td><td class="num">${byMonth[k].toFixed(1)}</td><td class="num">${(byMonth[k]/60).toFixed(2)}</td></tr>
  `).join('');

  sdiv.innerHTML = `
    <h3>Gesamt</h3>
    <p><b>${total.toFixed(1)} Minuten</b> (${(total/60).toFixed(2)} Stunden)</p>

    <h3>Nach Kunden</h3>
    <table>
      <thead><tr><th>Kunde</th><th class="num">Minuten</th><th class="num">Stunden</th></tr></thead>
      <tbody>${custRows}</tbody>
    </table>

    <h3>Nach Kalenderwoche</h3>
    <table>
      <thead><tr><th>Woche</th><th class="num">Minuten</th><th class="num">Stunden</th></tr></thead>
      <tbody>${weekRows}</tbody>
    </table>

    <h3>Nach Monat</h3>
    <table>
      <thead><tr><th>Monat</th><th class="num">Minuten</th><th class="num">Stunden</th></tr></thead>
      <tbody>${monthRows}</tbody>
    </table>
  `;
}

function exportCSV(){
  const filtered = entries.filter(entryPassesFilter);
  if(!filtered.length){ alert("Keine Daten fÃ¼r Export."); return; }
  let csv="Kunde;Art;Beschreibung;Dauer (Min);Datum;Zeit\n";
  filtered.forEach(e=>{
    const line = [
      e.kunde,
      e.art,
      (e.desc||"").replace(/\r?\n/g," "),
      e.duration,
      formatDateEU(e.datum),
      e.zeit
    ].join(";");
    csv+=line+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download="zeiten.csv";
  a.click();
}

function generateStatusPDF(){
  const k=document.getElementById("pdf-kunde").value;
  const d=document.getElementById("pdf-datum").value;
  if(!k||!d) return alert("Bitte Kunde & Datum auswÃ¤hlen!");
  window.open("export_status_pdf.php?kunde="+encodeURIComponent(k)+"&datum="+encodeURIComponent(d));
}

function generateInvoicePDF(){
  const k=document.getElementById("inv-kunde").value;
  const von=document.getElementById("inv-von").value;
  const bis=document.getElementById("inv-bis").value;
  const rate=document.getElementById("inv-rate").value;
  if(!k||!von||!bis) return alert("Bitte Kunde und Zeitraum (von/bis) auswÃ¤hlen!");
  const url="export_invoice_pdf.php?kunde="+encodeURIComponent(k)+
            "&von="+encodeURIComponent(von)+
            "&bis="+encodeURIComponent(bis)+
            (rate?("&rate="+encodeURIComponent(rate)):"");
  window.open(url);
}

document.addEventListener('DOMContentLoaded',()=>{
  loadCustomers();
  loadEntriesFromServer();
});
</script>

</body>
</html>
