<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Zeiterfassung | M.I.E Modern IT Experts GmbH</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary:#005BBB;
      --color-accent:#00B8D9;
      --color-dark:#0A1F44;
      --color-bg:#F7F9FC;
      --color-text:#333;
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Inter',sans-serif;
      margin:0;
      background:var(--color-bg);
      color:var(--color-text);
    }
    .container{
      max-width:1000px;
      margin:40px auto 60px;
      padding:0 20px;
    }
    h1{
      font-size:2rem;
      margin-bottom:10px;
      color:var(--color-dark);
    }
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:20px 0;
    }
    .tab{
      padding:10px 18px;
      border-radius:8px;
      border:1px solid #ccd6e0;
      background:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:0.95rem;
    }
    .tab.active{
      background:var(--color-primary);
      color:#fff;
      border-color:var(--color-primary);
    }
    .tab-content{
      display:none;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 8px 20px rgba(10,31,68,0.06);
    }
    .tab-content.active{display:block;}
    input,select,textarea{
      width:100%;
      padding:10px;
      margin:6px 0 12px;
      border-radius:8px;
      border:1px solid #dde3ec;
      font-size:0.95rem;
    }
    textarea{min-height:80px;resize:vertical;}
    button{
      padding:10px 16px;
      border:none;
      border-radius:8px;
      background:var(--color-primary);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:0.9rem;
    }
    button:hover{background:#0070e0;}
    .entry{
      background:#fff;
      padding:14px;
      margin-top:12px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      font-size:0.9rem;
    }
    .entry small{color:#7b8898;}
    .btn-small{
      padding:6px 10px;
      font-size:0.75rem;
      border-radius:999px;
      background:#eef2fb;
      color:var(--color-dark);
      border:none;
      cursor:pointer;
    }
    .btn-small.danger{
      background:#ffe5e5;
      color:#b30000;
    }
    .btn-small.danger:hover{background:#ffd0d0;}
    .btn-small:hover{background:#dde4f7;}
    .flex-row{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
    }
    .flex-row>div{flex:1 1 220px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.9rem;}
    th,td{padding:6px 4px;}
    th{border-bottom:1px solid #dde3ec;text-align:left;}
    td.num{text-align:right;}
    #calendar{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-top:20px;
    }
    .calendar-day{
      background:#fff;
      padding:10px;
      min-height:80px;
      border-radius:10px;
      text-align:center;
      cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,0.05);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size:0.85rem;
    }
    .calendar-day:hover{background:#eef6ff;}
    .calendar-day.disabled{
      background:#f0f0f0;
      color:#aaa;
      cursor:default;
      box-shadow:none;
    }
    .day-number{
      font-weight:700;
      font-size:1.1rem;
    }
    .day-hours{
      font-size:0.8rem;
      margin-top:4px;
      color:#005BBB;
      font-weight:600;
    }
    .month-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
    }
    .month-header button{
      padding:4px 10px;
      border-radius:999px;
      font-size:0.8rem;
      background:#eef2fb;
      color:var(--color-dark);
    }
    .month-header button:hover{background:#dde4f7;}
    @media(max-width:768px){
      .container{margin-top:20px;}
    }
  </style>
</head>
<body>

<header id="site-nav"></header>
<script>
fetch('nav.html').then(r=>r.text()).then(html=>document.getElementById('site-nav').innerHTML=html);
</script>

<main class="container">
  <h1>â±ï¸ Zeiterfassung</h1>

  <div class="tabs">
    <button class="tab active" onclick="openTab('eingabe', event)">ğŸ“ Eingabe</button>
    <button class="tab" onclick="openTab('tabelle', event)">ğŸ“‹ Tabelle</button>
    <button class="tab" onclick="openTab('auswertung', event)">ğŸ“Š Auswertung</button>
    <button class="tab" onclick="openTab('kalender', event)">ğŸ“… Kalender</button>
    <button class="tab" onclick="openTab('export', event)">ğŸ“¤ Export</button>
  </div>

  <!-- TAB Eingabe -->
  <section id="eingabe" class="tab-content active">
    <h2>Zeiterfassung eingeben</h2>

    <label>Kunde:</label>
    <input id="kunde" list="kundenListe" placeholder="Kunde eingeben oder auswÃ¤hlen">
    <datalist id="kundenListe"></datalist>

    <label>Art der TÃ¤tigkeit:</label>
    <select id="art">
      <option>Administration</option>
      <option>Support</option>
      <option>Absprache</option>
      <option>Call</option>
    </select>

    <label>Datum:</label>
    <input type="date" id="datum">

    <label>Beschreibung:</label>
    <textarea id="desc" placeholder="Kurzbeschreibung der TÃ¤tigkeit (ZeilenumbrÃ¼che mÃ¶glich)"></textarea>

    <h3>â± Timer</h3>
    <button id="timerBtn" onclick="toggleTimer()">â–¶ Timer starten</button>

    <p style="margin-top:10px;">ODER manuell eingeben:</p>
    <input type="number" id="manualTime" placeholder="Minuten, z. B. 30">
    <button onclick="saveManual()">ğŸ–Šï¸ Manuell speichern</button>
  </section>

  <!-- TAB Tabelle -->
  <section id="tabelle" class="tab-content">
    <h2>ğŸ“‹ Ãœbersicht</h2>

    <div class="flex-row">
      <div>
        <label>Filter Kunde:</label>
        <select id="filter-kunde">
          <option value="">(alle)</option>
        </select>
      </div>
      <div>
        <label>Von:</label>
        <input type="date" id="filter-von">
      </div>
      <div>
        <label>Bis:</label>
        <input type="date" id="filter-bis">
      </div>
      <div style="align-self:flex-end;">
        <button onclick="renderEntries()">Filter anwenden</button>
      </div>
    </div>

    <div id="entries"></div>
  </section>

  <!-- TAB Auswertung -->
  <section id="auswertung" class="tab-content">
    <h2>ğŸ“Š Auswertung</h2>

    <div class="flex-row">
      <div>
        <label>Kunde (optional):</label>
        <select id="stats-kunde">
          <option value="">(alle)</option>
        </select>
      </div>
      <div>
        <label>Von:</label>
        <input type="date" id="stats-von">
      </div>
      <div>
        <label>Bis:</label>
        <input type="date" id="stats-bis">
      </div>
      <div style="align-self:flex-end;">
        <button onclick="renderStats()">Neu berechnen</button>
      </div>
    </div>

    <div id="stats"></div>
  </section>

  <!-- TAB Kalender -->
  <section id="kalender" class="tab-content">
    <h2>ğŸ“… Kalender</h2>
    <div class="month-header">
      <button onclick="changeMonth(-1)">â€¹ Vorheriger Monat</button>
      <div id="month-label"></div>
      <button onclick="changeMonth(1)">NÃ¤chster Monat â€º</button>
    </div>
    <div id="calendar"></div>
    <div id="day-details" style="margin-top:20px;"></div>
  </section>

  <!-- TAB Export -->
  <section id="export" class="tab-content">
    <h2>ğŸ“¤ Export & Berichte</h2>

    <h3>Statusbericht (PDF) â€“ 1 Tag / Kunde</h3>
    <div class="flex-row">
      <div>
        <label>Kunde:</label>
        <select id="pdf-kunde"></select>
      </div>
      <div>
        <label>Datum:</label>
        <input type="date" id="pdf-datum">
      </div>
      <div style="align-self:flex-end;">
        <button onclick="generateStatusPDF()">ğŸ“„ Statusbericht als PDF</button>
      </div>
    </div>

    <hr style="margin:20px 0;">

    <h3>Leistungsnachweis / Rechnung (PDF) â€“ Zeitraum / Kunde</h3>
    <div class="flex-row">
      <div>
        <label>Kunde:</label>
        <select id="inv-kunde"></select>
      </div>
      <div>
        <label>Von:</label>
        <input type="date" id="inv-von">
      </div>
      <div>
        <label>Bis:</label>
        <input type="date" id="inv-bis">
      </div>
      <div>
        <label>Stundensatz (EUR):</label>
        <input type="number" id="inv-rate" placeholder="z. B. 95" step="0.01">
      </div>
      <div style="align-self:flex-end;">
        <button onclick="generateInvoicePDF()">ğŸ“‘ Leistungsnachweis / Rechnung</button>
      </div>
    </div>

    <hr style="margin:20px 0;">

    <h3>CSV Export (nach aktuellem Tabellenfilter)</h3>
    <button onclick="exportCSV()">ğŸ“¥ CSV Export</button>
  </section>

</main>

<footer id="site-footer"></footer>
<script>
fetch('footer.html').then(r=>r.text()).then(html=>document.getElementById('site-footer').innerHTML=html);
</script>

<script>
let timerRunning = false;
let startTime = null;
let editIndex = null;
let entries = [];
let currentMonthOffset = 0; // 0 = aktueller Monat

function formatDateEU(dateStr){
  if(!dateStr) return "";
  const parts = dateStr.split("-");
  if (parts.length !== 3) return dateStr;
  return parts[2]+"."+parts[1]+"."+parts[0];
}

function openTab(name, ev){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(ev) ev.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  if(name === 'tabelle') renderEntries();
  if(name === 'auswertung') renderStats();
  if(name === 'kalender') buildCalendar();
}

function loadCustomers(){
  fetch('kunden.json')
    .then(r=>r.json())
    .then(list=>{
      const dl = document.getElementById('kundenListe');
      const filterK = document.getElementById('filter-kunde');
      const statsK = document.getElementById('stats-kunde');
      const pdfK = document.getElementById('pdf-kunde');
      const invK = document.getElementById('inv-kunde');

      dl.innerHTML = '';
      [filterK, statsK, pdfK, invK].forEach(sel=>{
        if(sel === filterK || sel === statsK){
          sel.innerHTML = '<option value="">(alle)</option>';
        } else {
          sel.innerHTML = '';
        }
      });

      list.forEach(k=>{
        dl.innerHTML += `<option value="${k}"></option>`;
        [filterK, statsK, pdfK, invK].forEach(sel=>{
          const opt = document.createElement('option');
          opt.value = k;
          opt.textContent = k;
          sel.appendChild(opt);
        });
      });
    })
    .catch(err=>console.error('Kunden konnten nicht geladen werden', err));
}

function loadEntriesFromServer(){
  fetch('api_load_entries.php')
    .then(r=>r.json())
    .then(data=>{
      entries = Array.isArray(data) ? data : [];
      renderEntries();
      renderStats();
      buildCalendar();
    })
    .catch(err=>{
      console.error('Fehler beim Laden der EintrÃ¤ge', err);
      entries = [];
    });
}

function saveEntriesToServer(){
  return fetch('api_save_entries.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(entries)
  }).then(r=>r.json()).then(data=>{
    entries = Array.isArray(data) ? data : entries;
  }).catch(err=>{
    console.error('Fehler beim Speichern', err);
    alert('Fehler beim Speichern der Daten auf dem Server.');
  });
}

function getTimeString24h(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

function toggleTimer(){
  const btn = document.getElementById('timerBtn');
  if(!timerRunning){
    startTime = Date.now();
    timerRunning = true;
    btn.innerText = "â¹ Timer stoppen";
  } else {
    const dur = ((Date.now() - startTime) / 60000).toFixed(1);
    saveEntry(dur);
    timerRunning = false;
    btn.innerText = "â–¶ Timer starten";
  }
}

function saveManual(){
  const m = document.getElementById('manualTime').value;
  if(!m) return alert('Bitte Minuten eingeben!');
  saveEntry(m);
  document.getElementById('manualTime').value = '';
}

function saveEntry(duration){
  const kunde = document.getElementById('kunde').value.trim();
  const art = document.getElementById('art').value;
  const desc = document.getElementById('desc').value.trim();
  const datum = document.getElementById('datum').value;

  if(!kunde) return alert('Bitte Kunde eingeben!');
  if(!datum) return alert('Bitte Datum wÃ¤hlen!');

  const entry = {
    kunde,
    art,
    desc,
    duration: parseFloat(duration),
    datum,
    zeit: getTimeString24h()
  };

  if(editIndex !== null){
    entries[editIndex] = entry;
    editIndex = null;
    document.getElementById('timerBtn').innerText = "â–¶ Timer starten";
  } else {
    entries.push(entry);
  }

  saveEntriesToServer().then(()=>{
    renderEntries();
    renderStats();
    buildCalendar();
  });
}

function entryPassesFilter(e){
  const fk = document.getElementById('filter-kunde').value;
  const von = document.getElementById('filter-von').value;
  const bis = document.getElementById('filter-bis').value;
  if(fk && e.kunde !== fk) return false;
  if(von && e.datum < von) return false;
  if(bis && e.datum > bis) return false;
  return true;
}

function renderEntries(){
  const box = document.getElementById('entries');
  const filtered = entries.filter(entryPassesFilter);
  if(!filtered.length){
    box.innerHTML = "<p>Keine EintrÃ¤ge fÃ¼r den gewÃ¤hlten Filter.</p>";
    return;
  }
  box.innerHTML = filtered.map((e, i)=>`
    <div class="entry">
      <b>${e.kunde}</b> â€“ ${e.art} â€“ ${e.duration} Min<br>
      <small>${formatDateEU(e.datum)} um ${e.zeit} Uhr</small>
      <p>${(e.desc || '').replace(/\n/g,'<br>')}</p>
      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn-small" onclick="editEntry(${i})">âœï¸ Bearbeiten</button>
        <button class="btn-small danger" onclick="deleteEntry(${i})">âŒ LÃ¶schen</button>
      </div>
    </div>
  `).join('');
}

function deleteEntry(index){
  if(!confirm('Diesen Eintrag wirklich lÃ¶schen?')) return;
  entries.splice(index, 1);
  saveEntriesToServer().then(()=>{
    renderEntries();
    renderStats();
    buildCalendar();
  });
}

function editEntry(index){
  const e = entries[index];
  document.getElementById('kunde').value = e.kunde;
  document.getElementById('art').value = e.art;
  document.getElementById('datum').value = e.datum;
  document.getElementById('desc').value = e.desc;
  editIndex = index;
  openTab('eingabe');
  document.getElementById('timerBtn').innerText = "ğŸ’¾ Ã„nderungen speichern";
}

function statsFilter(e){
  const sk = document.getElementById('stats-kunde').value;
  const von = document.getElementById('stats-von').value;
  const bis = document.getElementById('stats-bis').value;
  if(sk && e.kunde !== sk) return false;
  if(von && e.datum < von) return false;
  if(bis && e.datum > bis) return false;
  return true;
}

function getISOWeek(d){
  const date = new Date(d.getTime());
  date.setHours(0,0,0,0);
  date.setDate(date.getDate() + 3 - ((date.getDay()+6)%7));
  const week1 = new Date(date.getFullYear(),0,4);
  return 1 + Math.round(((date - week1)/86400000 - 3 + ((week1.getDay()+6)%7))/7);
}

function renderStats(){
  const sdiv = document.getElementById('stats');
  const filtered = entries.filter(statsFilter);
  if(!filtered.length){
    sdiv.innerHTML = "<p>Keine EintrÃ¤ge im gewÃ¤hlten Zeitraum.</p>";
    return;
  }

  let total = 0;
  const byCustomer = {};
  const byWeek = {};
  const byMonth = {};

  filtered.forEach(e=>{
    const dur = parseFloat(e.duration) || 0;
    total += dur;

    byCustomer[e.kunde] = (byCustomer[e.kunde] || 0) + dur;

    const d = new Date(e.datum);
    if(!isNaN(d)){
      const year = d.getFullYear();
      const week = getISOWeek(d);
      const weekKey = `KW ${week}/${year}`;
      byWeek[weekKey] = (byWeek[weekKey] || 0) + dur;

      const monthKey = `${String(d.getMonth()+1).padStart(2,'0')}.${year}`;
      byMonth[monthKey] = (byMonth[monthKey] || 0) + dur;
    }
  });

  const custRows = Object.keys(byCustomer).map(k=>`
    <tr><td>${k}</td><td class="num">${byCustomer[k].toFixed(1)}</td><td class="num">${(byCustomer[k]/60).toFixed(2)}</td></tr>
  `).join('');

  const weekRows = Object.keys(byWeek).sort().map(k=>`
    <tr><td>${k}</td><td class="num">${byWeek[k].toFixed(1)}</td><td class="num">${(byWeek[k]/60).toFixed(2)}</td></tr>
  `).join('');

  const monthRows = Object.keys(byMonth).sort().map(k=>`
    <tr><td>${k}</td><td class="num">${byMonth[k].toFixed(1)}</td><td class="num">${(byMonth[k]/60).toFixed(2)}</td></tr>
  `).join('');

  sdiv.innerHTML = `
    <h3>Gesamt</h3>
    <p><b>${total.toFixed(1)} Minuten</b> (${(total/60).toFixed(2)} Stunden)</p>

    <h3>Nach Kunden</h3>
    <table>
      <thead><tr><th>Kunde</th><th class="num">Minuten</th><th class="num">Stunden</th></tr></thead>
      <tbody>${custRows}</tbody>
    </table>

    <h3>Nach Kalenderwoche</h3>
    <table>
      <thead><tr><th>Woche</th><th class="num">Minuten</th><th class="num">Stunden</th></tr></thead>
      <tbody>${weekRows}</tbody>
    </table>

    <h3>Nach Monat</h3>
    <table>
      <thead><tr><th>Monat</th><th class="num">Minuten</th><th class="num">Stunden</th></tr></thead>
      <tbody>${monthRows}</tbody>
    </table>
  `;
}

function buildCalendar(){
  const calendarDiv = document.getElementById('calendar');
  const label = document.getElementById('month-label');
  const detailDiv = document.getElementById('day-details');
  calendarDiv.innerHTML = '';
  detailDiv.innerHTML = '';

  const base = new Date();
  base.setMonth(base.getMonth() + currentMonthOffset);
  const year = base.getFullYear();
  const month = base.getMonth();

  const monthNames = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
  label.textContent = `${monthNames[month]} ${year}`;

  const firstDay = new Date(year, month, 1);
  let firstWeekday = firstDay.getDay();
  if(firstWeekday === 0) firstWeekday = 7;
  const daysInMonth = new Date(year, month+1, 0).getDate();

  const dailyTotals = {};
  entries.forEach(e=>{
    dailyTotals[e.datum] = (dailyTotals[e.datum] || 0) + (parseFloat(e.duration) || 0);
  });

  for(let i=1;i<firstWeekday;i++){
    const empty = document.createElement('div');
    empty.className = 'calendar-day disabled';
    calendarDiv.appendChild(empty);
  }

  for(let day=1; day<=daysInMonth; day++){
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const box = document.createElement('div');
    box.className = 'calendar-day';
    const total = dailyTotals[dateStr] || 0;
    const hoursLabel = total ? (total/60).toFixed(2) + ' Std' : '';

    box.innerHTML = `
      <div class="day-number">${day}</div>
      <div class="day-hours">${hoursLabel}</div>
    `;
    box.onclick = ()=>showDayDetails(dateStr);
    calendarDiv.appendChild(box);
  }
}

function changeMonth(delta){
  currentMonthOffset += delta;
  buildCalendar();
}

function showDayDetails(dateStr){
  const detailDiv = document.getElementById('day-details');
  const filtered = entries.filter(e=>e.datum === dateStr);
  if(!filtered.length){
    detailDiv.innerHTML = `<p>Keine EintrÃ¤ge fÃ¼r ${formatDateEU(dateStr)}.</p>`;
    return;
  }
  detailDiv.innerHTML = `<h3>${formatDateEU(dateStr)}</h3>` + filtered.map(e=>`
    <div class="entry">
      <b>${e.kunde}</b> â€“ ${e.art} â€“ ${e.duration} Min
      <p>${(e.desc || '').replace(/\n/g,'<br>')}</p>
    </div>
  `).join('');
}

function exportCSV(){
  const filtered = entries.filter(entryPassesFilter);
  if(!filtered.length){
    alert('Keine Daten fÃ¼r Export.');
    return;
  }
  let csv = "Kunde;Art;Beschreibung;Dauer (Min);Datum;Zeit\n";
  filtered.forEach(e=>{
    const line = [
      e.kunde,
      e.art,
      (e.desc || '').replace(/\r?\n/g,' '),
      e.duration,
      formatDateEU(e.datum),
      e.zeit
    ].join(';');
    csv += line + "\n";
  });
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "zeiten.csv";
  a.click();
}

function generateStatusPDF(){
  const k = document.getElementById('pdf-kunde').value;
  const d = document.getElementById('pdf-datum').value;
  if(!k || !d) return alert('Bitte Kunde und Datum auswÃ¤hlen!');
  window.open("export_status_pdf.php?kunde="+encodeURIComponent(k)+"&datum="+encodeURIComponent(d));
}

function generateInvoicePDF(){
  const k = document.getElementById('inv-kunde').value;
  const von = document.getElementById('inv-von').value;
  const bis = document.getElementById('inv-bis').value;
  const rate = document.getElementById('inv-rate').value;
  if(!k || !von || !bis) return alert('Bitte Kunde und Zeitraum (von/bis) auswÃ¤hlen!');
  let url = "export_invoice_pdf.php?kunde="+encodeURIComponent(k)+"&von="+encodeURIComponent(von)+"&bis="+encodeURIComponent(bis);
  if(rate) url += "&rate="+encodeURIComponent(rate);
  window.open(url);
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadCustomers();
  loadEntriesFromServer();
});
</script>

</body>
</html>
