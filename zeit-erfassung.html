<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zeiterfassung | M.I.E Modern IT Experts GmbH</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root { --color-primary:#005BBB; --color-dark:#0A1F44; --color-bg:#F7F9FC; }
body { font-family:Inter, sans-serif; background:var(--color-bg); margin:0; color:#333; }
.container { max-width:900px; margin:40px auto; padding:0 20px; }
h1 {color:var(--color-dark);}
input, select, textarea {
  width:100%; padding:10px; margin:8px 0;
  border:1px solid #ccc; border-radius:8px; font-size:1rem;
}
button {
  padding:12px 18px; border:none; border-radius:8px;
  background:var(--color-primary); color:#fff; cursor:pointer; font-weight:600;
}
button:hover { background:#0080ff; }
.tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab {
  padding:10px 18px; border-radius:8px; border:1px solid #ccc; background:#fff;
  cursor:pointer; font-weight:600;
}
.tab.active { background:#005BBB; color:#fff; border-color:#005BBB; }
.tab-content { display:none; background:#fff; padding:20px; border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08); }
.tab-content.active { display:block; }
.entry { background:#fff; padding:14px; margin-top:12px; border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08); }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { padding:6px 4px; }
th { border-bottom:1px solid #ccc; text-align:left; }
td.num { text-align:right; }
</style>
</head>

<body>

<header id="site-nav"></header>
<script>
fetch('nav.html').then(r=>r.text()).then(html=>document.getElementById('site-nav').innerHTML=html);
</script>

<div class="container">

<h1>â±ï¸ Zeiterfassung</h1>

<div class="tabs">
  <button class="tab active" onclick="openTab('eingabe')">ğŸ“ Eingabe</button>
  <button class="tab" onclick="openTab('tabelle')">ğŸ“‹ Tabelle</button>
  <button class="tab" onclick="openTab('auswertung')">ğŸ“Š Auswertung</button>
  <button class="tab" onclick="openTab('export')">ğŸ“¤ Export</button>
</div>

<div id="eingabe" class="tab-content active">
  <h2>Zeiterfassung eingeben</h2>

  <label>Kunde:</label>
  <input id="kunde" list="kundenListe" placeholder="Kunde eingeben oder auswÃ¤hlen">
  <datalist id="kundenListe"></datalist>

  <label>Art der TÃ¤tigkeit:</label>
  <select id="art">
    <option>Administration</option>
    <option>Support</option>
    <option>Absprache</option>
    <option>Call</option>
  </select>

  <label>Datum:</label>
  <input type="date" id="datum">

  <label>Beschreibung:</label>
  <textarea id="desc" rows="3"></textarea>

  <h3>â±ï¸ Zeit erfassen</h3>
  <button id="timerBtn" onclick="toggleTimer()">â–¶ Timer starten</button>

  <p>ODER manuell eingeben:</p>
  <input type="number" id="manualTime" placeholder="Minuten z. B. 30">
  <button onclick="saveManual()">ğŸ–Šï¸ Manuell speichern</button>
</div>

<div id="tabelle" class="tab-content">
  <h2>ğŸ“‹ Ãœbersicht aller EintrÃ¤ge</h2>
  <div id="entries"></div>
</div>

<div id="auswertung" class="tab-content">
  <h2>ğŸ“Š Auswertung</h2>
  <div id="stats"></div>
</div>

<div id="export" class="tab-content">
  <h2>ğŸ“¤ Export</h2>

  <h3>Statusbericht (PDF)</h3>
  <label>Kunde:</label>
  <select id="pdf-kunde"></select>

  <label>Datum:</label>
  <input type="date" id="pdf-datum">

  <button onclick="generatePDF()">ğŸ“„ Statusbericht als PDF</button>

  <h3 style="margin-top:30px;">CSV Export</h3>
  <button onclick="exportCSV()">ğŸ“„ CSV Export</button>
</div>

</div>

<footer id="site-footer"></footer>
<script>
fetch('footer.html').then(r=>r.text()).then(html=>document.getElementById('site-footer').innerHTML=html);
</script>

<script>
let timerRunning=false, startTime=null, editIndex=null, entries=[];

function formatDateEU(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}.${month}.${year}`;
}

function openTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  if(name==='tabelle') renderEntries();
  if(name==='auswertung') renderStats();
}

function loadCustomers(){
  fetch('kunden.json')
    .then(r=>r.json())
    .then(list=>{
      const dl=document.getElementById('kundenListe');
      const pdf=document.getElementById('pdf-kunde');
      dl.innerHTML='';
      pdf.innerHTML='';
      list.forEach(k=>{
        dl.innerHTML+=`<option value="${k}"></option>`;
        pdf.innerHTML+=`<option value="${k}">${k}</option>`;
      });
    });
}

function loadEntriesFromServer(){
  fetch('api_load_entries.php')
    .then(r=>r.json())
    .then(data=>{
      entries = Array.isArray(data)?data:[];
      renderEntries();
      renderStats();
    });
}

function saveEntriesToServer(){
  return fetch('api_save_entries.php',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(entries)
  })
  .then(r=>r.json())
  .then(data=>{ entries=data; })
}

function toggleTimer(){
  if(!timerRunning){
    startTime=Date.now();
    timerRunning=true;
    timerBtn.innerText="â¹ Timer stoppen";
  } else {
    const dur=((Date.now()-startTime)/60000).toFixed(1);
    saveEntry(dur);
    timerRunning=false;
    timerBtn.innerText="â–¶ Timer starten";
  }
}

function saveManual(){
  const m=document.getElementById("manualTime").value;
  if(!m) return alert("Bitte Minuten eingeben!");
  saveEntry(m);
  document.getElementById("manualTime").value='';
}

function saveEntry(duration){
  const kunde=document.getElementById("kunde").value.trim(),
        art=document.getElementById("art").value,
        desc=document.getElementById("desc").value.trim(),
        datum=document.getElementById("datum").value;

  if(!kunde) return alert("Bitte Kunde eingeben!");
  if(!datum) return alert("Bitte Datum wÃ¤hlen!");

  const entry={
    kunde, art, desc, duration,
    datum,
    zeit:new Date().toLocaleTimeString("de-DE")
  };

  if(editIndex!==null){
    entries[editIndex]=entry;
    editIndex=null;
  } else {
    entries.push(entry);
  }

  saveEntriesToServer().then(renderEntries);
}

function renderEntries(){
  const box=document.getElementById("entries");
  if(!entries.length){ box.innerHTML="<p>Noch keine Daten.</p>"; return; }

  box.innerHTML=entries.map((e,i)=>`
    <div class="entry">
      <b>${e.kunde}</b> â€“ ${e.art} â€“ ${e.duration} Min<br>
      <small>${formatDateEU(e.datum)} um ${e.zeit}</small>
      <p>${e.desc}</p>
      <button onclick="editEntry(${i})" style="background:#FFA500;">âœï¸ Bearbeiten</button>
      <button onclick="deleteEntry(${i})" style="background:#D9534F;">âŒ LÃ¶schen</button>
    </div>
  `).join('');
}

function deleteEntry(i){
  if(!confirm("LÃ¶schen?")) return;
  entries.splice(i,1);
  saveEntriesToServer().then(renderEntries);
}

function editEntry(i){
  const e=entries[i];
  kunde.value=e.kunde;
  art.value=e.art;
  datum.value=e.datum;
  desc.value=e.desc;
  editIndex=i;
  openTab('eingabe');
}

function renderStats(){
  if(!entries.length){
    stats.innerHTML="<p>Keine EintrÃ¤ge.</p>";
    return;
  }

  let total=0;
  const byCustomer={};

  entries.forEach(e=>{
    total+=parseFloat(e.duration);
    byCustomer[e.kunde]=(byCustomer[e.kunde]||0)+parseFloat(e.duration);
  });

  stats.innerHTML = `
    <h3>Gesamt</h3>
    <p>${total.toFixed(1)} Min (${(total/60).toFixed(2)} Std)</p>
    <h3>Nach Kunden</h3>
    <table><thead><tr><th>Kunde</th><th class='num'>Min</th><th class='num'>Std</th></tr></thead>
    <tbody>
    ${Object.keys(byCustomer).map(k=>`
      <tr><td>${k}</td><td class="num">${byCustomer[k].toFixed(1)}</td>
      <td class="num">${(byCustomer[k]/60).toFixed(2)}</td></tr>
    `).join('')}
    </tbody></table>
  `;
}

function generatePDF(){
  const k=document.getElementById("pdf-kunde").value;
  const d=document.getElementById("pdf-datum").value;
  if(!k||!d) return alert("Bitte Kunde & Datum auswÃ¤hlen!");
  window.open("export_pdf.php?kunde="+encodeURIComponent(k)+"&datum="+encodeURIComponent(d));
}

function exportCSV(){
  if(!entries.length){ alert("Keine Daten."); return; }
  let csv="Kunde;Art;Beschreibung;Dauer;Datum;Zeit\n";
  entries.forEach(e=>{
    csv+=`${e.kunde};${e.art};${e.desc.replace(/\n/g,' ')};${e.duration};${formatDateEU(e.datum)};${e.zeit}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download="zeiten.csv";
  a.click();
}

document.addEventListener('DOMContentLoaded',()=>{
  loadCustomers();
  loadEntriesFromServer();
});
</script>

</body>
</html>